# クローラーのリンク検出アレコレ

@suginoy

Kawasaki.rb 70th

---
# クローラー
---
## クローラーの効能

- HTTP、HTML、SEO、文字コードに詳しくなる
- データモデリングの練習になる
- 各サイトの実装方針に詳しくなる
  - SPA
  - APIの分け方、バージョニング
- 中の人より仕様やバグに詳しくなる
- 一意なURLとは何かといった哲学的な問いを考えだす

---
## 作っているクローラの特徴

- Rails 製
  - `libcurl` ラッパーの [Typhoeus](https://github.com/typhoeus/typhoeus)
  - [nokogiri](https://nokogiri.org/)
- クローリングとスクレイピングを（できるだけ）分ける
  - クローリングが成功していれば、スクレイピングは後でやり直せる
- 1 つの URL に対して 1 日 に複数回アクセスは重複とみなす
- データモデルをまるごとリバースエンジニアリング
- URLのパスやパラメータごとにスクレイパーを個別に用意する

---
## リンク出現箇所

- `<body>` 中の静的な `a` タグ
- `<head>` タグ内の `<link>` タグ
  - `rel="canonical"`
  - `rel="next"`
  - `rel="prev"`
- JavaScript が叩きに行っているエンドポイント
- HTTP リダイレクトの Location ヘッダ
- sitemap.xml
- JSON-LD 内の microdata

---
## 実際に遭遇したツライ事例集

---
## `a` タグ(1)

サイトマップページ内の100ほどあるリンクの一部に間違いリンクがある

---
## `a` タグ(2)

改行

```html
<a href="

https://example.com">リンク先</a>
```

=> `String#strip`, `String#squish` などで対応

---
## `a` タグ(3)

垂直タブ文字(VT)が埋まっている

=> むしろどうやって入力した？

---
## `a` タグ(5) `href="index.html"`

- ほんとは `href="/index.html"` と書きたかったらしい。
- ブラウザの実装上では、現在の Location が `https://example.com/foo` だったら  `https://example.com/foo/index.html` となるらしい。

=> このサイトだけ個別対応

---
## `a` タグ(6)

一見、階層型のパンくずリスト

- 上位から 1 対 N の構造ではなく N 対 M の構造
- リンクのラベル名がとリンク先が違う
  - 例）あるカテゴリ名をクリックするとリンク先がサイトマップ

 => `a` タグのラベル名は信用せず、リンク先の title タグの値を優先

---
## `a` タグ(7) ソーシャルリンク

EUC-JP で埋まっていたりする

=> ドメイン判定して無視

---
## 企業間の提携
- 別サービスのコンテンツを表示している箇所があり、一部のコード体系が違う
- さらにページレイアウトも違うことがある

=> スクレイパーの中で特定のコードか、目印となる HTML の構造を検出してロジックを分岐する（タブの数とか）

---
## HTTP リダイレクト(0)

- レスポンスヘッダに `Location` パラメータでやってくる
- ブラウザ型クローラーで検知しにくい
- ライブラリのリダイレクトオプションを知らず、HTTPクライアントライブラリを入れ替えたり

---
## HTTP リダイレクト(1)

### `http://` => `https://`
- ある日突然 HTTPS 強制で、保存していた URL が軒並み死んだ。
- リダイレクト先がおかしい

---
## HTTP リダイレクト(2)

別のコードにすげ変わっている

- `https://example.com/items/0111` (リダイレクト前)
- `https://example.com/items/0222` (リダイレクト後)

=> スクレイピング側の対応が必要

---
## 「公開終了」

`404` のサイトと `200` のサイトがある

=> 不完全なデータができる

---
## 同じURLとは何か

- 謎の動的リクエストパラメータ `_`
  - 必ず付いている `"?_=123424324132143"` とは何ぞ？
    - => ユリウス時刻を1000倍したものらしいとわかる
    - => JavaScript で `new Date()` すると取得できるらしい
    - => クローリング時にRuby で `Date.today.jd * 1_000` して偽装する

---
## 画面によって API のパラメータの順番が違う？
- `?codeA=1&codeB=2`
- `?codeB=2&codeA=1`

=> 専用のパースクラスと用意して、主要なパラメータが一致したら同じとみなす。

---
## ページネーション(0)
- 昨日の1ページ目と今日の1ページ目は違う
- 昨日のページ数と今日のページ数は違う

---
## ページネーション(1)
- 無限スクロールのページネーション API
  - URL は同一だが、URLのパラメータに見当たらない
  - HTTP ヘッダに `X-xxxView-Page` というパラメータで埋まっていた。
  - 最後のページになると `X-xxx-NEXT` に `NG` というパラメータが __HTTPレスポンスヘッダで__ 返ってくる

---
## ページネーション(2)
- 無限スクロールの画面をよく見ると 1 ページ目のHTML の `<head>` 内に `<link rel="canonical">` でページ番号付きの HTML ページが存在している
- URL 直打ちだと辿りつけるページが意外とある
- ブラウザからノーガードでアクセスできる API も結構ある

---
## ページネーション(3)
- JSON API を叩くと `item_count` のような値が取れるので最終ページが計算できる
=> 実際のレスポンスの件数を数えるとちょいちょい合っていない

---
## sitemap.xml
- 更新日時などは嘘が多いので、URLのみ利用するのが吉
- 大手でもSEO下手で存在しないサイトがある

---
## JSON-LD の microdata

リンクを埋め込む仕様があるが、そういうサイトは `link rel="canonical"` もあるので、だいたい無視してよい。

---
## おしまい
